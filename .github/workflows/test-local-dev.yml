name: Test Local Development Environment

on:
  pull_request:

jobs:
  test-local-dev-simulation:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Install minikube and kubectl
      run: |
        # Install kubectl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        
        # Install minikube
        curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        sudo install minikube-linux-amd64 /usr/local/bin/minikube
        
        # Verify installations
        kubectl version --client
        minikube version
    
    - name: Start minikube
      run: |
        minikube start --driver=docker --memory=4096 --cpus=2
        minikube addons enable ingress
        minikube addons enable storage-provisioner
        kubectl cluster-info
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build and load images
      run: |
        # Build images using minikube's docker daemon
        eval $(minikube docker-env)
        
        echo "Building backend..."
        docker build -t vteam-backend:latest components/backend
        
        echo "Building frontend..."
        docker build -t vteam-frontend:latest components/frontend
        
        echo "Building operator..."
        docker build -t vteam-operator:latest components/operator
        
        echo "Images built successfully"
        docker images | grep vteam
    
    - name: Deploy application
      run: |
        echo "Creating namespace..."
        kubectl create namespace ambient-code
        kubectl label namespace ambient-code ambient-code.io/managed=true
        
        echo "Installing CRDs..."
        kubectl apply -f components/manifests/base/crds/agenticsessions-crd.yaml
        kubectl apply -f components/manifests/base/crds/projectsettings-crd.yaml
        
        echo "Creating PersistentVolumeClaim..."
        kubectl apply -f components/manifests/base/workspace-pvc.yaml -n ambient-code
        
        echo "Setting up RBAC..."
        kubectl apply -f components/manifests/minikube/local-dev-rbac.yaml
        kubectl apply -f components/manifests/base/rbac/cluster-roles.yaml
        kubectl apply -f components/manifests/base/rbac/backend-clusterrole.yaml
        kubectl apply -f components/manifests/base/rbac/backend-clusterrolebinding.yaml
        kubectl apply -f components/manifests/base/rbac/operator-clusterrole.yaml
        kubectl apply -f components/manifests/base/rbac/operator-clusterrolebinding.yaml
        
        echo "Deploying backend..."
        kubectl apply -f components/manifests/minikube/backend-deployment.yaml
        kubectl apply -f components/manifests/minikube/backend-service.yaml
        
        echo "Deploying frontend..."
        kubectl apply -f components/manifests/minikube/frontend-deployment.yaml
        kubectl apply -f components/manifests/minikube/frontend-service.yaml
        
        echo "Deploying operator..."
        kubectl apply -f components/manifests/minikube/operator-deployment.yaml
        
        echo "Setting up ingress..."
        kubectl apply -f components/manifests/minikube/ingress.yaml
        
        echo "Checking deployment objects..."
        kubectl get deployments -n ambient-code -o wide
        
        echo ""
        echo "Waiting for deployments to be ready (will timeout if pods fail)..."
        kubectl wait --for=condition=available --timeout=180s deployment/backend-api -n ambient-code || echo "⚠️  Backend deployment timeout"
        kubectl wait --for=condition=available --timeout=180s deployment/frontend -n ambient-code || echo "⚠️  Frontend deployment timeout"
        kubectl wait --for=condition=available --timeout=180s deployment/agentic-operator -n ambient-code || echo "⚠️  Operator deployment timeout"
        
        echo ""
        echo "Pod status:"
        kubectl get pods -n ambient-code -o wide || echo "No pods found"
        
        echo ""
        echo "Events (last 20):"
        kubectl get events -n ambient-code --sort-by='.lastTimestamp' | tail -20 || true
        
        echo ""
        echo "Deployment details:"
        kubectl describe deployments -n ambient-code | grep -A 10 "Conditions:\|Events:" || true
        
        echo ""
        echo "ReplicaSets:"
        kubectl get replicasets -n ambient-code -o wide || true
        
        echo ""
        echo "Checking for pod failures..."
        if kubectl get pods -n ambient-code 2>/dev/null | grep -q "ImagePullBackOff\|CrashLoopBackOff\|Error"; then
          echo "⚠️  Found pods with errors - describing them:"
          kubectl describe pods -n ambient-code || true
        fi
    
    - name: Run comprehensive test suite
      run: |
        echo "Running local development test suite..."
        chmod +x tests/local-dev-test.sh
        
        # Run tests in CI mode (known failures tracked separately)
        ./tests/local-dev-test.sh --skip-setup --ci || {
          echo "Test suite failed - showing debugging information..."
          
          # Show pod logs for debugging
          echo "=== Backend logs ==="
          kubectl logs -n ambient-code -l app=backend-api --tail=100 || true
          
          echo "=== Operator logs ==="
          kubectl logs -n ambient-code -l app=agentic-operator --tail=100 || true
          
          echo "=== Frontend logs ==="
          kubectl logs -n ambient-code -l app=frontend --tail=50 || true
          
          exit 1
        }
    
    - name: Validate production manifest safety
      if: always()
      run: |
        echo "Validating production manifests do NOT contain dev mode variables..."
        
        # Check base and production manifests for DISABLE_AUTH
        for manifest in components/manifests/base/*.yaml components/manifests/overlays/production/*.yaml; do
          if [ -f "$manifest" ]; then
            if grep -q "DISABLE_AUTH" "$manifest"; then
              echo "❌ CRITICAL: Production manifest contains DISABLE_AUTH: $manifest"
              exit 1
            fi
            
            if grep -qE "ENVIRONMENT.*[\"']?(local|development)[\"']?" "$manifest"; then
              echo "❌ CRITICAL: Production manifest sets ENVIRONMENT=local/development: $manifest"
              exit 1
            fi
          fi
        done
        
        echo "✅ All production manifests are safe"
        
    - name: Show deployment status
      if: always()
      run: |
        echo "=== Namespace ==="
        kubectl get namespace ambient-code || true
        
        echo ""
        echo "=== Deployments ==="
        kubectl get deployments -n ambient-code -o wide || true
        
        echo ""
        echo "=== ReplicaSets ==="
        kubectl get replicasets -n ambient-code -o wide || true
        
        echo ""
        echo "=== Pods ==="
        kubectl get pods -n ambient-code -o wide || true
        
        echo ""
        echo "=== Services ==="
        kubectl get svc -n ambient-code || true
        
        echo ""
        echo "=== Ingress ==="
        kubectl get ingress -n ambient-code || true
        
        echo ""
        echo "=== CRDs ==="
        kubectl get crd | grep vteam || true
        
        echo ""
        echo "=== Events (last 30) ==="
        kubectl get events -n ambient-code --sort-by='.lastTimestamp' | tail -30 || true
        
        echo ""
        echo "=== Deployment describe (if no pods) ==="
        if ! kubectl get pods -n ambient-code 2>/dev/null | grep -q "backend-api\|frontend\|agentic-operator"; then
          echo "No pods found - describing deployments for details:"
          kubectl describe deployment backend-api -n ambient-code 2>/dev/null | tail -50 || true
          kubectl describe deployment frontend -n ambient-code 2>/dev/null | tail -50 || true
          kubectl describe deployment agentic-operator -n ambient-code 2>/dev/null | tail -50 || true
        fi
    
    - name: Cleanup
      if: always()
      run: |
        kubectl delete namespace ambient-code --ignore-not-found=true || true
        minikube delete || true
