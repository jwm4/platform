name: Corrections Feedback Loop

on:
  schedule:
    # Weekly on Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      since_days:
        description: 'Number of days to look back for corrections'
        required: false
        default: '7'
      min_corrections:
        description: 'Minimum corrections per group to trigger improvement'
        required: false
        default: '2'
      dry_run:
        description: 'Dry run (query and report without creating sessions)'
        required: false
        default: 'false'

permissions:
  contents: read

jobs:
  # ------------------------------------------------------------------
  # Job 1: Query Langfuse, group corrections, write session configs
  # ------------------------------------------------------------------
  query-corrections:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      session_count: ${{ steps.query.outputs.session_count }}
      indices: ${{ steps.query.outputs.indices }}
      dry_run: ${{ steps.query.outputs.dry_run }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r scripts/feedback-loop/requirements.txt

      - name: Query corrections and build session configs
        id: query
        env:
          LANGFUSE_HOST: ${{ secrets.LANGFUSE_HOST }}
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          AMBIENT_API_URL: ${{ secrets.AMBIENT_API_URL }}
          AMBIENT_BOT_TOKEN: ${{ secrets.AMBIENT_BOT_TOKEN }}
          AMBIENT_PROJECT: ${{ secrets.AMBIENT_PROJECT }}
          REPOS_FILTER: ${{ secrets.FEEDBACK_LOOP_REPOS_FILTER }}
        run: |
          mkdir -p /tmp/feedback-loop
          python scripts/feedback-loop/query_corrections.py \
            --langfuse-host "$LANGFUSE_HOST" \
            --langfuse-public-key "$LANGFUSE_PUBLIC_KEY" \
            --langfuse-secret-key "$LANGFUSE_SECRET_KEY" \
            --api-url "$AMBIENT_API_URL" \
            --api-token "$AMBIENT_BOT_TOKEN" \
            --project "$AMBIENT_PROJECT" \
            --since-days "${{ github.event.inputs.since_days || '7' }}" \
            --min-corrections "${{ github.event.inputs.min_corrections || '2' }}" \
            --output-file /tmp/feedback-loop/output.json \
            --repos-filter "$REPOS_FILTER" \
            --output-mode matrix \
            ${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }}

      - name: Upload session configs
        if: steps.query.outputs.session_count != '0'
        uses: actions/upload-artifact@v4
        with:
          name: session-configs
          path: /tmp/feedback-loop/sessions.json
          retention-days: 1

      - name: Query summary
        if: always()
        run: |
          echo "### Feedback Loop — Query Results" >> $GITHUB_STEP_SUMMARY
          if [ -f /tmp/feedback-loop/query-results.json ]; then
            python3 -c "
          import json
          d = json.load(open('/tmp/feedback-loop/query-results.json'))
          print(f'- **Corrections found**: {d[\"corrections_found\"]}')
          print(f'- **Sessions to create**: {d[\"session_count\"]}')
          if d.get('dry_run'):
              print('- **Mode**: dry run (no sessions will be created)')
          print()
          sessions = d.get('sessions', [])
          if sessions:
              print('#### Planned Sessions')
              print()
              for s in sessions:
                  print(f'- {s[\"display_name\"]} ({s[\"target_type\"]})')
          " >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
          else
            echo "- No query results generated" >> $GITHUB_STEP_SUMMARY
          fi

  # ------------------------------------------------------------------
  # Job 2: Create sessions via ambient-action (one per matrix index)
  # ------------------------------------------------------------------
  create-sessions:
    needs: query-corrections
    if: >-
      needs.query-corrections.outputs.session_count != '0' &&
      needs.query-corrections.outputs.dry_run != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      matrix:
        index: ${{ fromJSON(needs.query-corrections.outputs.indices) }}
      fail-fast: false

    steps:
      - name: Download session configs
        uses: actions/download-artifact@v4
        with:
          name: session-configs

      - name: Extract session config
        id: config
        env:
          MATRIX_INDEX: ${{ matrix.index }}
        run: |
          python3 << 'PYEOF'
          import hashlib, json, os

          with open('sessions.json') as f:
              sessions = json.load(f)

          index = int(os.environ["MATRIX_INDEX"])
          s = sessions[index]

          out = os.environ['GITHUB_OUTPUT']
          with open(out, 'a') as f:
              f.write(f"display-name={s['display_name']}\n")
              f.write(f"repos={json.dumps(s.get('repos', []))}\n")
              f.write(f"labels={json.dumps(s.get('labels', {}))}\n")
              f.write(f"environment-variables={json.dumps(s.get('environment_variables', {}))}\n")
              # Prompt is multi-line — use a unique EOF delimiter
              prompt = s['prompt']
              tag = hashlib.sha256(prompt.encode()).hexdigest()[:12]
              delim = f"GHEOF_{tag}"
              f.write(f"prompt<<{delim}\n")
              f.write(prompt)
              f.write(f"\n{delim}\n")
          PYEOF

      - name: Create improvement session
        id: session
        uses: ambient-code/ambient-action@v2
        with:
          api-url: ${{ secrets.AMBIENT_API_URL }}
          api-token: ${{ secrets.AMBIENT_BOT_TOKEN }}
          project: ${{ secrets.AMBIENT_PROJECT }}
          prompt: ${{ steps.config.outputs.prompt }}
          display-name: ${{ steps.config.outputs.display-name }}
          repos: ${{ steps.config.outputs.repos }}
          labels: ${{ steps.config.outputs.labels }}
          environment-variables: ${{ steps.config.outputs.environment-variables }}

      - name: Session summary
        if: always()
        run: |
          echo "- **${{ steps.config.outputs.display-name }}**: session \`${{ steps.session.outputs.session-name }}\` created" >> $GITHUB_STEP_SUMMARY

  # ------------------------------------------------------------------
  # Job 3: Aggregate summary
  # ------------------------------------------------------------------
  summary:
    needs: [query-corrections, create-sessions]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Final summary
        run: |
          echo "### Feedback Loop — Final Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          QUERY_RESULT="${{ needs.query-corrections.result }}"
          SESSION_RESULT="${{ needs.create-sessions.result }}"
          echo "- **Query job**: ${QUERY_RESULT}" >> $GITHUB_STEP_SUMMARY
          echo "- **Session creation**: ${SESSION_RESULT:-skipped}" >> $GITHUB_STEP_SUMMARY
